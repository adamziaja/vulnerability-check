#!/usr/bin/php -q
<?php
$vfeed = $argv[1];
$nmap = $argv[2];

echo "http://code.google.com/p/vulnerability-check/\n";
echo "(C) 2013 Adam Ziaja <adam@adamziaja.com> http://adamziaja.com\n";

$db = new SQLite3($vfeed);
$xml = simplexml_load_file($nmap);

foreach ($xml->host as $host) {
    $cpe_array = array();
    echo "\n\033[1;32m" . $host->address{'addr'} . "\033[0m\n";
    foreach ($host->ports->port as $port) {
        $cpe = (string) $port->service->cpe;
        array_push($cpe_array, $cpe);
    }
    foreach (array_unique($cpe_array) as $cpe) {
        echo "\033[1;34m" . $cpe . "\033[0m\n";
        $results = $db->query("SELECT cveid FROM cve_cpe WHERE cpeid = '$cpe'");
        while ($row = $results->fetchArray()) {
            $cve = $row['cveid'];
            echo "\033[1;31mhttps://web.nvd.nist.gov/view/vuln/detail?vulnId=" . $cve . "\033[0m\n";
            $cve_results = $db->query("SELECT summary FROM nvd_db WHERE cveid = '$cve'");
            while ($cve_row = $cve_results->fetchArray()) {
                echo $cve_row['summary'] . "\n";
            }
        }
    }
}
?>
